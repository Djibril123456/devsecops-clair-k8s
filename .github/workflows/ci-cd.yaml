name: CI-CD DevSecOps (Clair + K8s)

on:
  push:
    branches: ["main"]

permissions:
  contents: read
  packages: write
  security-events: write

jobs:
  build_scan_deploy:
    runs-on: self-hosted

    env:
      IMAGE_NAME: ghcr.io/${{ github.repository }}:sha-${{ github.sha }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Docker login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Build image
        run: |
          docker build -t "${IMAGE_NAME}" ./app

      - name: Push image
        run: |
          docker push "${IMAGE_NAME}"

      
            - name: Clair scan (JSON report)
        run: |
          # Dossier de sortie
          mkdir -p reports

          # Lance un Clair local (dans Docker) + DB interne
          docker network create clairnet || true

          docker run -d --rm --name clair-postgres --network clairnet \
            -e POSTGRES_PASSWORD=clair -e POSTGRES_USER=clair -e POSTGRES_DB=clair \
            postgres:16

          docker run -d --rm --name clair --network clairnet -p 6060:6060 -p 6061:6061 \
            quay.io/projectquay/clair:latest

          # Attendre que Clair réponde
          for i in $(seq 1 30); do
            curl -fsS http://localhost:6060/healthz && break || true
            sleep 2
          done

          # Télécharger clairctl
          curl -L -o clairctl https://github.com/quay/clair/releases/latest/download/clairctl-linux-amd64
          chmod +x clairctl

          # Scanner l’image
          ./clairctl --config <(cat <<'EOF'
          clair:
            host: http://localhost:6060
          EOF
          ) report "${IMAGE_NAME}" > reports/clair-report.json

          # Nettoyage
          docker stop clair || true
          docker stop clair-postgres || true
          docker network rm clairnet || true

      - name: Upload Clair report artifact
        uses: actions/upload-artifact@v4
        with:
          name: clair-report
          path: reports/clair-report.json


      - name: Deploy to Kubernetes (kind)
        run: |
          
          sed "s|ghcr.io/OWNER/REPO:latest|${IMAGE_NAME}|g" k8s/deployment.yaml | kubectl apply -f -
          kubectl rollout status deploy/devsecops-app --timeout=120s
          kubectl get pods -o wide
