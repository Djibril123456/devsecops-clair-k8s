name: CI-CD DevSecOps (Clair + K8s)

on:
  push:
    branches: ["main"]

permissions:
  contents: read
  packages: write
  security-events: write

jobs:
  build_scan_deploy:
    runs-on: self-hosted

    env:
      IMAGE_NAME: ghcr.io/${{ github.repository }}:sha-${{ github.sha }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Docker login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Build image
        run: |
          docker build -t "${IMAGE_NAME}" ./app

      - name: Push image
        run: |
          docker push "${IMAGE_NAME}"

      
      - name: Clair scan (SARIF)
        uses: quay/clair-action@main
        with:
          image-ref: ${{ env.IMAGE_NAME }}
          format: sarif
          output: clair_results.sarif
          return-code: "1"

      - name: Upload SARIF to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: clair_results.sarif

      - name: Deploy to Kubernetes (kind)
        run: |
          
          sed "s|ghcr.io/OWNER/REPO:latest|${IMAGE_NAME}|g" k8s/deployment.yaml | kubectl apply -f -
          kubectl rollout status deploy/devsecops-app --timeout=120s
          kubectl get pods -o wide
